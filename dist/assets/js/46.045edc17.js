(window.webpackJsonp=window.webpackJsonp||[]).push([[46],{425:function(t,s,a){"use strict";a.r(s);var e=a(15),n=Object(e.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"分析源码系列-vue-set-vm-set-详解"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#分析源码系列-vue-set-vm-set-详解"}},[t._v("#")]),t._v(" 分析源码系列 - Vue.set / "),a("code",[t._v("vm.$set")]),t._v(" 详解")]),t._v(" "),a("p"),a("div",{staticClass:"table-of-contents"},[a("ul",[a("li",[a("a",{attrs:{href:"#作用和概念描述"}},[t._v("作用和概念描述")]),a("ul",[a("li",[a("a",{attrs:{href:"#小结"}},[t._v("小结")])])])]),a("li",[a("a",{attrs:{href:"#为什么用过-set-添加的就是响应式属性"}},[t._v("为什么用过 set 添加的就是响应式属性")])]),a("li",[a("a",{attrs:{href:"#开始看源码"}},[t._v("开始看源码")]),a("ul",[a("li",[a("a",{attrs:{href:"#调试模式下，进入-set-方法"}},[t._v("调试模式下，进入 set 方法")])]),a("li",[a("a",{attrs:{href:"#添加监听-definereactive-1-方法"}},[t._v("添加监听 defineReactive$$1 方法")])]),a("li",[a("a",{attrs:{href:"#dep-分析"}},[t._v("dep 分析")])]),a("li",[a("a",{attrs:{href:"#observe-分析"}},[t._v("observe 分析")])])])]),a("li",[a("a",{attrs:{href:"#总结"}},[t._v("总结")])])])]),a("p"),t._v(" "),a("h2",{attrs:{id:"作用和概念描述"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#作用和概念描述"}},[t._v("#")]),t._v(" 作用和概念描述")]),t._v(" "),a("p",[a("a",{attrs:{href:"https://cn.vuejs.org/v2/api/#Vue-set",target:"_blank",rel:"noopener noreferrer"}},[t._v("官方文档：Vue-set"),a("OutboundLink")],1)]),t._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[t._v("作用")]),t._v(" "),a("p",[t._v("向响应式对象中添加一个 property，并确保这个新 property 同样是响应式的，且触发视图更新。它必须用于向响应式对象上添加新 property，"),a("strong",[t._v("因为 Vue 无法探测普通的新增 property (比如 this.myObject.newProperty = 'hi')")])])]),t._v(" "),a("div",{staticClass:"custom-block warning"},[a("p",{staticClass:"custom-block-title"},[t._v("局限性")]),t._v(" "),a("p",[t._v("不允许动态添加根级响应式属性。比如：")]),t._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 错误写法")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("$"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("set")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'newkey'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1111")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 正确写法")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("$"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("set")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("obj"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'newkey'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("111")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 取值： this.obj.newkey => 111")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br")])]),a("p",[a("img",{attrs:{src:"https://gitee.com/Jioho/img/raw/master/knowledge/20200628151402.png",alt:""}})])]),t._v(" "),a("h3",{attrs:{id:"小结"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#小结"}},[t._v("#")]),t._v(" 小结")]),t._v(" "),a("ul",[a("li",[a("code",[t._v("Vue.set")]),t._v(" 和 "),a("code",[t._v("vm.$set")]),t._v(" 方法其实都是同一个，只是写法上不太一样")]),t._v(" "),a("li",[t._v("效果都是为页面动态添加属性，并且动态添加的属性也是响应式的属性")])]),t._v(" "),a("h2",{attrs:{id:"为什么用过-set-添加的就是响应式属性"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#为什么用过-set-添加的就是响应式属性"}},[t._v("#")]),t._v(" 为什么用过 set 添加的就是响应式属性")]),t._v(" "),a("p",[t._v("先看下 vue 响应式原理："),a("RouterLink",{attrs:{to:"/Vue/vue双向数据绑定原理.html"}},[t._v("vue 双向数据绑定原理")]),a("br"),t._v("\n可以看到响应式其实依赖于一个 "),a("code",[t._v("Object.defineProperty")]),a("br"),t._v("\n而 "),a("code",[t._v("Object.defineProperty")]),t._v("只监听某个对象下的一个属性，如果有多个属性需要分别监听")],1),t._v(" "),a("p",[t._v("看个 demo 理解下：")]),t._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" data "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\nObject"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("defineProperty")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("data"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'data1'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("get")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'get data1'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("value\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("set")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("newVal")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'set data1'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("value "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" newVal\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\ndata"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("data1 "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("111")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 将会打印 set data1")]),t._v("\nconsole"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("data"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("data1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 先打印 get data1  然后才是 111")]),t._v("\n\ndata"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("data2 "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("222")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 无打印，无报错")]),t._v("\nconsole"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("data"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("data2"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 直接打印222。表示没有进过 `Object.defineProperty`")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br"),a("span",{staticClass:"line-number"},[t._v("17")]),a("br"),a("span",{staticClass:"line-number"},[t._v("18")]),a("br")])]),a("h2",{attrs:{id:"开始看源码"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#开始看源码"}},[t._v("#")]),t._v(" 开始看源码")]),t._v(" "),a("p",[t._v("来一个调试的 demo")]),t._v(" "),a("div",{staticClass:"language-html line-numbers-mode"},[a("div",{staticClass:"highlight-lines"},[a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("div",{staticClass:"highlighted"},[t._v(" ")]),a("div",{staticClass:"highlighted"},[t._v(" ")]),a("br"),a("br")]),a("pre",{pre:!0,attrs:{class:"language-html"}},[a("code",[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("script")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("src")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("https://cdn.jsdelivr.net/npm/vue/dist/vue.js"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),a("span",{pre:!0,attrs:{class:"token script"}}),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("script")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("script")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),a("span",{pre:!0,attrs:{class:"token script"}},[a("span",{pre:!0,attrs:{class:"token language-javascript"}},[t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" app "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Vue")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    el"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'#app'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    data"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      addData"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("debugger")]),t._v("\n  app"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("$"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("set")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("app"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("addData"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'newkey'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1111")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])]),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("script")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n")])]),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br")])]),a("p",[t._v("第一个进入 "),a("code",[t._v("$set")]),t._v(" 方法的时候，默认先来到了取值部分，这时候 return 了一个空值，在 return 后，再次进入 "),a("code",[t._v("$set")]),t._v(" 才是我们需要调试的部分\n"),a("img",{attrs:{src:"https://gitee.com/Jioho/img/raw/master/knowledge/20200628160948.png",alt:""}})]),t._v(" "),a("h3",{attrs:{id:"调试模式下，进入-set-方法"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#调试模式下，进入-set-方法"}},[t._v("#")]),t._v(" 调试模式下，进入 set 方法")]),t._v(" "),a("details",{staticClass:"custom-block details"},[a("summary",[t._v("1081 行 2 个方法用于检测目标节点的数据类型，也就是 `$set` 的第一个参数的检测。 展开查看相关检测方法")]),t._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("isUndef")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("v")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" v "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("undefined")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v(" v "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/**\n * Check if value is primitive.\n */")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("isPrimitive")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("value")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("typeof")]),t._v(" value "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'string'")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("typeof")]),t._v(" value "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'number'")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// $flow-disable-line")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("typeof")]),t._v(" value "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'symbol'")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("typeof")]),t._v(" value "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'boolean'")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br")])])]),t._v(" "),a("ul",[a("li",[t._v("1085 - 1089 判断的是数组类型，毕竟由于特殊的类型"),a("code",[t._v("Object.defindPropety")]),t._v("无法检测数组的变化，所以数组变化是手动更新的。")]),t._v(" "),a("li",[t._v("1090 - 1093 便是判断属性是否原先就已经存在了，存在就没必要重复监听了")]),t._v(" "),a("li",[t._v("1095 - 1100 就是判断不能在根节点 "),a("code",[t._v("this.data")]),t._v(" 直接去添加数据了")]),t._v(" "),a("li",[t._v("注意 1094 行变量 "),a("code",[t._v("ob")]),t._v(" 就是 observed(观察者) 的简称。也是用于判断该变量是否已经被监听过了")]),t._v(" "),a("li",[t._v("监听过无须重复重复监听的值都会直接返回对应的 "),a("code",[t._v("val")]),t._v("。这也是 "),a("code",[t._v("$set")]),t._v(" 返回当前值的一个 return")]),t._v(" "),a("li",[t._v("如果是新增的对象，那就走到了 1106 行 "),a("code",[t._v("defineReactive$$1")]),t._v(" 方法中")])]),t._v(" "),a("p",[a("img",{attrs:{src:"https://gitee.com/Jioho/img/raw/master/knowledge/20200628161129.png",alt:""}})]),t._v(" "),a("h3",{attrs:{id:"添加监听-definereactive-1-方法"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#添加监听-definereactive-1-方法"}},[t._v("#")]),t._v(" 添加监听 "),a("code",[t._v("defineReactive$$1")]),t._v(" 方法")]),t._v(" "),a("ul",[a("li",[t._v("1021 行 初始化 "),a("code",[t._v("new Dep")]),t._v(" "),a("a",{attrs:{href:"#dep-%E5%88%86%E6%9E%90"}},[t._v("查看 dep 的分析")]),t._v(" 看 dep 分析还是很有必要的。这涉及后面许多的流程")]),t._v(" "),a("li",[t._v("1023 - 1026 判断该对象是否可读写")]),t._v(" "),a("li",[t._v("1019 - 1033 获取目标对象上的 "),a("code",[t._v("get")]),t._v(" 和 "),a("code",[t._v("set")]),t._v(" 方法.")]),t._v(" "),a("li",[t._v("1035 有个 shallow 变量，在我们前面的代码中这个变量是不存在的 "),a("code",[t._v("!shallow")]),t._v(" 即为 true。所以执行了 "),a("code",[t._v("observe")]),t._v(" 方法 "),a("a",{attrs:{href:"#observe-%E5%88%86%E6%9E%90"}},[t._v("查看 observe 分析")])]),t._v(" "),a("li",[t._v("看完上面的 "),a("code",[t._v("observe")]),t._v(" 分析 我们知道了 "),a("code",[t._v("observe")]),t._v(" 就是为他的子属性，循环添加监听的。")]),t._v(" "),a("li",[t._v("1039 行 绑定了获取属性值的事件，在获取对应的值的时候， "),a("code",[t._v("Dep.target")]),t._v(" 刚才也看到了，是一个全局的观察者"),a("code",[t._v("watch")]),t._v("。那如果存在 "),a("code",[t._v("dep.target")]),t._v(" 为当前的对象调用一个 "),a("code",[t._v("depend")]),t._v(" 方法，这个方法是从 "),a("code",[t._v("Dep")]),t._v(" 继承过来的。相当于也是为 watch 注册一个回调事件把（这估计是为 "),a("code",[t._v("watch")]),t._v(" 和 "),a("code",[t._v("computed")]),t._v(" 埋下的一个伏笔）")]),t._v(" "),a("li",[t._v("1052 行开始 "),a("code",[t._v("set")]),t._v(" 方法 。也是先从自身的 "),a("code",[t._v("getter")]),t._v(" 里面获取当前的值")]),t._v(" "),a("li",[t._v("1069 行，如果我们新复制的是一个对象，他还得循环重新为这些对象添加一个数据挟持，如果已经挟持过的就可以跳过，也就是上面的代码了")]),t._v(" "),a("li",[t._v("最后 1070 行，set 后，调用了 "),a("code",[t._v("dep.notify()")]),t._v("。这里面存储对应对象更新需要触发的时间(订阅观察者模式)。既然值更新了，就触发给相关的订阅函数 "),a("strong",[t._v("(watch 也是这时候触发了，视图也是这时候更新了)")]),t._v("。而且我们前面有拿到 set 之前的值，所以 "),a("code",[t._v("watch")]),t._v(" 方法里面"),a("code",[t._v("newVal")]),t._v("和"),a("code",[t._v("oldVal")]),t._v("就是这时候被记录下来的")]),t._v(" "),a("li",[t._v("最终就返回当前的值，"),a("code",[t._v("$set")]),t._v(" 方法也就执行结束了")])]),t._v(" "),a("p",[a("img",{attrs:{src:"https://gitee.com/Jioho/img/raw/master/knowledge/20200628162522.png",alt:""}}),t._v(" "),a("img",{attrs:{src:"https://gitee.com/Jioho/img/raw/master/knowledge/20200628162544.png",alt:""}})]),t._v(" "),a("hr"),t._v(" "),a("h3",{attrs:{id:"dep-分析"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#dep-分析"}},[t._v("#")]),t._v(" dep 分析")]),t._v(" "),a("p",[t._v("dep 代码不是很长。dep 就相当于是一个订阅中心")]),t._v(" "),a("ul",[a("li",[t._v("717 行 可以看到每一个 dep 都有对应的 ID，并且自增的")]),t._v(" "),a("li",[t._v("718 行可以看做是一个事件中心，所有的监听都存储到了这里")]),t._v(" "),a("li",[t._v("可以看到 dep 原型上有几个方法 "),a("code",[t._v("addSub")]),t._v(" "),a("code",[t._v("removeSub")]),t._v(" "),a("code",[t._v("depend")]),t._v(" "),a("code",[t._v("notify")]),t._v("。都是用于操作对应的监听，添加/删除，找到对应的依赖，通知这几个方法")]),t._v(" "),a("li",[t._v("725 行 "),a("code",[t._v("Dep.target")]),t._v(" 有非常详细的注释，全局唯一的观察者")])]),t._v(" "),a("p",[a("strong",[t._v("最核心的就是记住几个 "),a("code",[t._v("addSub")]),t._v(" "),a("code",[t._v("removeSub")]),t._v(" "),a("code",[t._v("depend")]),t._v(" "),a("code",[t._v("notify")]),t._v(" 方法。然后接着刚才的代码继续看")])]),t._v(" "),a("p",[a("img",{attrs:{src:"https://gitee.com/Jioho/img/raw/master/knowledge/20200628163227.png",alt:""}})]),t._v(" "),a("h3",{attrs:{id:"observe-分析"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#observe-分析"}},[t._v("#")]),t._v(" observe 分析")]),t._v(" "),a("p",[t._v("尤大贴心的注释")]),t._v(" "),a("blockquote",[a("p",[t._v("Attempt to create an observer instance for a value,"),a("br"),t._v("\n尝试为值创建观察者实例"),a("br"),t._v("\nreturns the new observer if successfully observed,"),a("br"),t._v("\n如果成功观察到，则返回新的观察者"),a("br"),t._v("\nor the existing observer if the value already has one."),a("br"),t._v("\n或现有的观察者（如果值已包含一个）")])]),t._v(" "),a("ul",[a("li",[a("p",[t._v("看来 "),a("code",[t._v("value.__ob__")]),t._v(" 如果存在，那这个属性就已经有观察者了，这也是我们 "),a("code",[t._v("$set")]),t._v(" 第一步中的一个判断，判断 "),a("code",[t._v("__ob__")]),t._v("的")])]),t._v(" "),a("li",[a("p",[t._v("然后区分了数组的，数组并没有观察者")])]),t._v(" "),a("li",[a("p",[t._v("主要看 1003 行，创建一个新的观察者 "),a("code",[t._v("new Observe")]),t._v(" 注意是大写的，不是当前的对象了")])]),t._v(" "),a("li",[a("p",[a("code",[t._v("new Observe")]),t._v(" 在下面图二，就不分开讲了")])]),t._v(" "),a("li",[a("p",[t._v("926 行。为"),a("code",[t._v("__ob__")]),t._v(" 添加属性，不要搞错了，并且把"),a("code",[t._v("__ob__")]),t._v("设置为不可枚举类型。具体可以看下 926 行进去的代码")])]),t._v(" "),a("li",[a("p",[t._v("927-933 都是为数组的操作了")])]),t._v(" "),a("li",[a("p",[t._v("935 行，当前对象的 walk 方法。直接贴上代码，可以看到是一个循环，把我们的对象遍历了一次，并且为每个对象都调用了 "),a("code",[t._v("defineReactive$$1")]),t._v(" 。可以看到备注，只有值是对象类型，才会调用这个方法。")])]),t._v(" "),a("li",[a("p",[t._v("既然调用了 "),a("code",[t._v("defineReactive$$1")]),t._v(" 。那这里就形成了一个递归，递归的头部，就是当属性，不再是对象的时候，就停止调用 "),a("code",[t._v("defineReactive$$1")]),t._v("。")])]),t._v(" "),a("li",[a("p",[t._v("看到这里之后，下一步应该回到 "),a("a",{attrs:{href:"#%E6%B7%BB%E5%8A%A0%E7%9B%91%E5%90%AC-definereactive-1-%E6%96%B9%E6%B3%95"}},[t._v("添加监听 defineReactive$$1 方法")]),t._v(" 的 第 1035 行")])])]),t._v(" "),a("p",[a("img",{attrs:{src:"https://gitee.com/Jioho/img/raw/master/knowledge/20200628164723.png",alt:""}})]),t._v(" "),a("p",[a("img",{attrs:{src:"https://gitee.com/Jioho/img/raw/master/knowledge/20200628180231.png",alt:""}})]),t._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("div",{staticClass:"highlight-lines"},[a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("div",{staticClass:"highlighted"},[t._v(" ")]),a("br"),a("br"),a("br")]),a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/**\n * Walk through all properties and convert them into\n * getter/setters. This method should only be called when\n * value type is Object.\n */")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Observer")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("prototype"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("walk")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("walk")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("obj")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" keys "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Object"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("keys")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("obj"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" i "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" i "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" keys"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("length"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" i"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("++")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("defineReactive$$1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("obj"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" keys"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("i"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br")])]),a("h2",{attrs:{id:"总结"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[t._v("#")]),t._v(" 总结")]),t._v(" "),a("ul",[a("li",[a("p",[t._v("vue 响应式原理依赖于 "),a("code",[t._v("Object.defindPropety")]),t._v("的 "),a("code",[t._v("get")]),t._v(" 和 "),a("code",[t._v("set")]),t._v(" 方法，分别在这 2 个方法去触发对应的事件")])]),t._v(" "),a("li",[a("p",[t._v("由于 JS 和 "),a("code",[t._v("Object.defindPropety")]),t._v("的限制，以至于不能动态添加需要监听的属性，所以就要用到 "),a("code",[t._v("Vue.set()")]),t._v("方法")])]),t._v(" "),a("li",[a("p",[a("code",[t._v("Vue.set()")]),t._v(" 方法内部是一个循环处理的过程，如果当前新增监听的是一个对象，那就继续调用自己形成一个递归，直到最后的"),a("strong",[t._v("子属性")]),t._v("是一个"),a("code",[t._v("数组/非对象类型")]),t._v("的参数后，递归结束，然后为自己添加监听，在监听中又会触发其他相关的方法(Dep 中订阅的事件就会被触发)。形成我们常见的双向数据绑定")])]),t._v(" "),a("li",[a("p",[t._v("由于 "),a("code",[t._v("Object.defindPropety")]),t._v(" 只能监听对象的变化，所以对于数组内某一个索引的值发生改变也是不能监听到的，于是还要用到"),a("code",[t._v("Vue.set")]),t._v(" 手动去触发更新，这时候的"),a("code",[t._v("Vue.set")]),t._v("只会做值的更新，而不会重复新增监听")])])])])}),[],!1,null,null,null);s.default=n.exports}}]);